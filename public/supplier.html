<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Portal - Interu</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            background: linear-gradient(135deg, #a8c8a8, #7db07d, #6b9b6b, #5a8a5a), url('/background-image.png') no-repeat center center fixed;
            background-size: cover, cover;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(168,200,168,0.03) 0%, rgba(125,176,125,0.02) 40%, rgba(107,155,107,0.01) 70%, rgba(90,138,90,0.02) 100%);
            pointer-events: none;
            z-index: -1;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        .main-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 20px 50px rgba(90, 138, 90, 0.25),
                0 8px 32px rgba(107, 155, 107, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            min-height: 85vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .interu-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 252, 248, 0.98) 100%);
            padding: 24px 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(125, 176, 125, 0.15);
            backdrop-filter: blur(10px);
        }
        .interu-logo {
            display: flex;
            align-items: center;
        }
        .interu-logo svg {
            height: 34px;
            width: auto;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }
        .role-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }
        .role-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }
        .role-tab.active {
            background: #4a7c59;
            color: white;
        }
        .main-content {
            display: flex;
            min-height: calc(80vh - 80px);
        }
        .left-panel {
            flex: 1;
            padding: 30px;
            background: white;
        }
        .right-panel {
            flex: 1;
            background: linear-gradient(135deg, rgba(248, 252, 248, 0.9) 0%, rgba(240, 248, 240, 0.95) 100%);
            padding: 30px;
            border-left: 1px solid rgba(125, 176, 125, 0.15);
            backdrop-filter: blur(8px);
        }

        .hidden { display: none !important; }
        .collapsed { display: none; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        .section-header h3 {
            color: #4a7c59;
            font-weight: 600;
            margin: 0;
        }
        .section-toggle {
            background: none;
            border: none;
            font-size: 16px;
            color: #6c757d;
            cursor: pointer;
        }
        .section-content {
            transition: all 0.3s ease;
        }
        .section-content.collapsed {
            display: none;
        }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 500; 
            color: #495057;
            font-size: 14px;
        }
        .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 12px 16px; 
            border: 1px solid #dee2e6; 
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4a7c59;
            box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
        .reference-input-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .reference-preview-section {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            padding: 24px;
            min-height: 300px;
        }
        .reference-counter {
            color: #4a7c59;
            font-weight: 600;
            margin-bottom: 16px;
            font-size: 16px;
        }
        .reference-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s;
        }
        .reference-card:hover {
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.1);
        }
        .reference-card-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reference-card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-right: 30px;
        }
        .reference-card-field {
            font-size: 14px;
        }
        .reference-card-label {
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 4px;
        }
        .reference-card-value {
            color: #495057;
            font-weight: 600;
        }

        .form-actions { 
            text-align: center; 
            padding-top: 2rem; 
            margin-top: 2rem;
            border-top: 1px solid #e9ecef; 
        }
        .submit-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            margin-top: 24px;
        }
        .environmental-message {
            position: absolute;
            bottom: 40px;
            right: 40px;
            max-width: 420px;
            color: rgba(255, 255, 255, 0.95);
            font-style: italic;
            font-size: 17px;
            line-height: 1.5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 300;
            letter-spacing: 0.3px;
            backdrop-filter: blur(2px);
            padding: 12px;
            border-radius: 8px;
            background: rgba(125, 176, 125, 0.1);
        }

        .sub-tabs {
            display: flex;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 24px;
        }
        .sub-tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }
        .sub-tab.active {
            background: #4a7c59;
            color: white;
            box-shadow: 0 2px 4px rgba(74, 124, 89, 0.2);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn { 
            background: #4a7c59; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { 
            background: #3d6447; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);
        }
        .btn-secondary { 
            background: transparent;
            color: #4a7c59;
            border: 1px solid #4a7c59;
        }
        .btn-secondary:hover { 
            background: #4a7c59;
            color: white;
        }
        .btn-add {
            background: transparent;
            color: #4a7c59;
            border: 2px dashed #4a7c59;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-add:hover {
            background: rgba(74, 124, 89, 0.05);
            transform: none;
            box-shadow: none;
        }
        .btn:disabled { 
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .alert { padding: 15px; margin: 15px 0; border-radius: 4px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .history-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
        }
        .submission-history { max-height: 500px; overflow-y: auto; }
        .submission-group { 
            margin-bottom: 20px; 
            border: 1px solid #e9ecef; 
            border-radius: 12px; 
            overflow: hidden;
            background: white;
        }
        .group-header { 
            background: linear-gradient(135deg, #4a7c59, #6a9969);
            color: white;
            padding: 16px 20px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .submission-time { color: rgba(255, 255, 255, 0.8); font-size: 0.9em; }
        .references-list { padding: 16px; }
        .reference-item { 
            display: grid; 
            grid-template-columns: 1fr 1fr auto; 
            gap: 15px; 
            padding: 12px; 
            border-bottom: 1px solid #f1f3f4; 
            align-items: center;
            border-radius: 6px;
        }
        .reference-item:last-child { border-bottom: none; }
        .reference-item:hover { background: #f8f9fa; }
        .reference-number { font-weight: 600; color: #4a7c59; }
        .validation-number { color: #28a745; font-weight: 500; }
        .ref-time { color: #6c757d; font-size: 0.85em; }

        .progress { 
            width: 100%; 
            height: 24px; 
            background: #e9ecef; 
            border-radius: 12px; 
            overflow: hidden; 
            margin: 16px 0;
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #4a7c59, #6a9969);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-wrapper">
            <div class="interu-header">
                <div class="interu-logo">
                    <svg width="112" height="34" viewBox="0 0 112 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4.18417 5.25758C4.81186 5.72512 5.57911 5.95843 6.48437 5.95843C7.38963 5.95843 8.16394 5.72512 8.80669 5.25758C9.44883 4.79066 9.77066 4.03079 9.77066 2.97921C9.77066 1.92763 9.44883 1.13212 8.80669 0.679025C8.16394 0.226549 7.40469 0 6.52863 0C5.59325 0 4.81217 0.226849 4.18417 0.679025C3.55587 1.13242 3.24234 1.89905 3.24234 2.97921C3.24234 4.05938 3.55587 4.79066 4.18417 5.25758Z" fill="#4a7c59"/>
                        <path d="M11.3042 31.2178C10.7783 31.0862 10.3547 30.809 10.0335 30.3854C9.71165 29.9624 9.5515 29.3271 9.5515 28.4796V10.0771H0.174903V12.2239H0.569593C1.06541 12.2239 1.56215 12.283 2.0592 12.3995C2.55563 12.5166 2.97891 12.7717 3.32995 13.1661C3.68037 13.5605 3.85558 14.1669 3.85558 14.9846V28.5235C3.85558 29.371 3.68713 29.9987 3.35208 30.4075C3.01579 30.817 2.5919 31.0866 2.08133 31.2181C1.56983 31.3497 1.06572 31.4152 0.569593 31.4152H0V33.562H13.3634V31.4152H12.8375C12.3407 31.4152 11.8296 31.3497 11.3042 31.2181V31.2178Z" fill="#4a7c59"/>
                        <path d="M27.041 30.3193C27.2888 30.7576 27.6392 31.05 28.0926 31.1957L28.0923 31.196C28.5448 31.3426 29.0925 31.4152 29.7353 31.4152H29.9108V33.562H20.9725V18.8841C20.9725 16.9857 20.6728 15.5176 20.0743 14.4805C19.4756 13.4443 18.4313 12.9251 16.9417 12.9251C15.8603 12.9251 15.0061 13.2469 14.3784 13.8891C13.7501 14.5318 12.6478 16.0574 12.6478 16.0574V13.3631C13.2316 12.2531 13.8669 11.4284 14.5536 10.8877C15.2397 10.3473 15.9845 9.98953 16.7884 9.81432C17.5913 9.63881 18.4602 9.5512 19.3953 9.5512C21.6737 9.5512 23.455 10.2231 24.7408 11.5667C26.026 12.9107 26.6688 15.0719 26.6688 18.0514V28.3041C26.6688 29.2096 26.7923 29.8813 27.041 30.3193Z" fill="#4a7c59"/>
                        <path d="M43.6157 30.9329C42.6222 30.9329 41.8698 30.6043 41.3592 29.9471C40.8477 29.2896 40.5926 28.2752 40.5926 26.9018V12.8808H46.2445V10.0768H40.5926V4.64372H37.5691C37.3644 5.6953 37.0874 6.58672 36.7367 7.31647C36.3862 8.04713 35.9919 8.66068 35.5538 9.15681C35.0863 9.62434 34.5023 10.019 33.8011 10.3396C33.1003 10.6615 32.3551 10.8216 31.5664 10.8216V12.8808H34.8963V27.1209C34.8963 29.6621 35.4441 31.444 36.5393 32.4664C37.6349 33.4891 39.2191 33.9997 41.2934 33.9997C42.5202 33.9997 43.608 33.8902 44.5576 33.6711C45.5065 33.4522 46.2006 33.2404 46.6389 33.0357V30.5385C46.1711 30.6556 45.6968 30.7506 45.2148 30.8234C44.7331 30.8966 44.1995 30.9329 43.6157 30.9329Z" fill="#4a7c59"/>
                        <path d="M88.789 13.2097H88.7884L88.789 13.21L88.789 13.2097Z" fill="#4a7c59"/>
                        <path d="M92.5124 12.18C91.665 12.8666 90.424 13.2096 88.789 13.2097C88.9067 12.307 88.8394 11.2562 88.4229 10.6157C87.9956 9.95817 87.4737 9.66216 86.8263 9.66216C85.7247 9.66216 85.0781 10.617 84.4685 11.5173C84.418 11.5919 84.3677 11.6662 84.3174 11.7395C83.9365 12.2949 82.7872 14.0495 81.8712 15.4531C81.0588 16.6977 80.6263 18.1516 80.6263 19.6379V28.4793C80.6263 29.3268 80.772 29.9621 81.0643 30.3851C81.356 30.8087 81.7504 31.0859 82.2475 31.2175C82.7439 31.3491 83.284 31.4145 83.8683 31.4145H85.2267V33.5613H71.3376V31.4145H71.4689C72.1402 31.4145 72.7319 31.342 73.2434 31.1954C73.754 31.0494 74.1634 30.7506 74.4702 30.2972C74.7767 29.8447 74.9301 29.1657 74.9301 28.2598V15.2028C74.9301 14.3265 74.7834 13.677 74.492 13.2531C74.2 12.8301 73.8056 12.5522 73.3092 12.4207C72.8122 12.2891 72.2422 12.2236 71.6004 12.2236H71.4689V10.0768H79.5311L80.3635 13.8448H80.5826C80.5826 13.8448 82.2118 11.5366 83.7254 9.38489C84.2455 8.64531 85.132 7.52734 86.2288 6.79023C87.1297 6.18466 88.1871 5.88312 89.1714 5.85545C90.7634 5.81057 91.6831 6.21141 92.3227 6.73704C93.0697 7.3509 93.6347 8.17932 93.7158 9.31758C93.7988 10.4835 93.3589 11.4942 92.5124 12.18Z" fill="#4a7c59"/>
                        <path d="M111.346 31.4149C110.761 31.4149 110.221 31.3568 109.725 31.2393C109.228 31.1231 108.841 30.8671 108.564 30.4727C108.286 30.078 108.147 29.458 108.147 28.6102V10.0771H98.99V12.2239H99.1216C99.7351 12.2239 100.29 12.2894 100.787 12.421C101.283 12.5525 101.685 12.8227 101.991 13.2316C102.298 13.641 102.452 14.2828 102.452 15.1592V23.7907C102.452 25.1349 102.291 26.3251 101.97 27.3619C101.648 28.3991 101.151 29.2023 100.48 29.7715C99.8073 30.3411 98.931 30.6261 97.8508 30.6261C96.8872 30.6261 96.127 30.378 95.5725 29.881C95.0173 29.3849 94.6306 28.6763 94.4118 27.756C94.1926 26.836 94.0832 25.7478 94.0832 24.4918V17.5141H88.3872V25.3682C88.3872 28.3474 89.0075 30.5314 90.2494 31.9184C91.4906 33.3062 93.2504 33.9997 95.5294 33.9997C96.9019 33.9997 98.1868 33.7731 99.3847 33.3207C100.582 32.8682 101.619 31.8529 102.495 30.2757H102.715L103.547 33.5617H111.609V31.4149H111.346Z" fill="#4a7c59"/>
                        <path d="M51.2583 12.6838C53.0836 10.596 55.6466 9.5512 58.9477 9.5512L58.9483 9.55181C62.0157 9.55181 64.418 10.4356 66.1563 12.2027C67.8936 13.9699 68.7629 16.5913 68.7629 20.0673V22.2141H56.9506V19.5853H62.9354C62.9354 17.3066 62.6357 15.5102 62.0372 14.1958C61.4381 12.8815 60.3657 12.2242 58.9922 12.2242C57.6188 12.2242 56.5387 12.8526 55.7499 14.1082C54.9608 15.3642 54.5081 17.1904 54.3916 19.585L54.3039 22.2138C54.3916 25.252 54.9535 27.4646 55.9909 28.8515C57.0271 30.2394 58.5103 30.9329 60.4379 30.9329C61.9561 30.9329 63.2419 30.5975 64.2935 29.9249C65.3454 29.2536 66.1338 28.4648 66.6598 27.5593C66.9807 27.7056 67.2361 27.9466 67.4267 28.2822C67.616 28.6182 67.7113 29.0052 67.7113 29.4433C67.7113 30.1736 67.4116 30.8892 66.8131 31.5904C66.214 32.2912 65.3082 32.8685 64.0964 33.321C62.8841 33.7734 61.3284 34 59.43 34C55.9245 34 53.2302 32.9416 51.3463 30.8234C49.462 28.7058 48.5198 25.7481 48.5198 21.951C48.5198 17.8618 49.4324 14.7725 51.2583 12.6838Z" fill="#4a7c59"/>
                    </svg>
                </div>
                <div class="role-tabs">
                    <button class="role-tab active" onclick="switchRole('supplier')">Supplier</button>
                    <button class="role-tab" onclick="switchRole('customer')">Customer</button>
                </div>
            </div>

            <div class="main-content">
                <!-- Authentication Section -->
                <div id="auth-section" class="left-panel">
                    <h2 style="color: #4a7c59; margin-bottom: 24px;">Email Verification</h2>
                    <div id="email-form">
                        <div class="form-group">
                            <label for="email">Email Address:</label>
                            <input type="email" id="email" placeholder="Enter your email address" required>
                        </div>
                        <button class="btn" onclick="sendOTP()">Send Verification Code</button>
                        <button class="btn btn-secondary" onclick="testLogin()" style="margin-left: 12px;">Skip Email Verification (Test Mode)</button>
                    </div>

                    <div id="otp-form" class="hidden">
                        <div class="form-group">
                            <label for="otp">Verification Code:</label>
                            <input type="text" id="otp" placeholder="Enter 6-digit code" maxlength="6" required>
                        </div>
                        <button class="btn" onclick="verifyOTP()">Verify Code</button>
                        <button class="btn btn-secondary" onclick="resendOTP()" style="margin-left: 12px;">Resend Code</button>
                    </div>
                </div>

                <!-- Main Application Section -->
                <div id="app-section" class="left-panel hidden">
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="showTab('submit')">Submit References</button>
                        <button class="sub-tab" onclick="showTab('history')">History</button>
                    </div>

                    <!-- Submit Tab -->
                    <div id="submit-tab" class="tab-content active">
                        <!-- Purchase Order Information Section -->
                        <div class="section-header" onclick="toggleSection('po-section')">
                            <h3 id="po-section-title">▼ Purchase Order Information</h3>
                        </div>
                        <div id="po-section" class="section-content">
                            <div class="form-row three-col">
                                <div class="form-group">
                                    <label for="po-number">PO Number</label>
                                    <input type="text" id="po-number" value="235235" required>
                                </div>
                                <div class="form-group">
                                    <label for="delivery-id">Delivery ID</label>
                                    <input type="text" id="delivery-id" value="2ffff4" required>
                                </div>
                                <div class="form-group">
                                    <label for="delivery-postcode">Delivery Postcode</label>
                                    <input type="text" id="delivery-postcode" placeholder="Enter postcode" required>
                                </div>
                            </div>
                        </div>

                        <!-- Add Reference Numbers Section -->
                        <div class="section-header">
                            <h3>Add Reference Numbers:</h3>
                        </div>
                        <div class="reference-input-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="reference-number">Reference Number</label>
                                    <input type="text" id="reference-number" placeholder="Enter reference number">
                                </div>
                                <div class="form-group">
                                    <label for="validation-number">Validation Number (Optional)</label>
                                    <input type="text" id="validation-number" placeholder="Enter validation number">
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center; margin-top: 16px;">
                                <button type="button" class="btn-add" onclick="addReference()">
                                    <span style="font-size: 16px;">+</span> Add Reference
                                </button>
                                <button type="button" class="btn-add" onclick="addCSVFile()">
                                    <span style="font-size: 16px;">📎</span> Add CSV File
                                </button>
                            </div>
                        </div>
                        
                        <div class="submit-section">
                            <button type="button" class="btn" onclick="submitAllReferences()" style="background: #000; padding: 16px 48px; font-size: 16px;">
                                Submit References
                            </button>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="history-tab" class="tab-content">
                        <div class="history-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h3 style="color: #4a7c59; margin: 0;">Submission History</h3>
                                <button class="btn btn-secondary" onclick="loadHistory()">Refresh</button>
                            </div>
                            <div id="history-content" class="submission-history">
                                <p style="color: #6c757d; text-align: center; padding: 40px;">Click refresh to load your submission history.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel for Reference Previews -->
                <div id="preview-panel" class="right-panel hidden">
                    <div class="reference-preview-section">
                        <div id="reference-counter" class="reference-counter">0 References created</div>
                        <div id="reference-cards"></div>
                    </div>
                </div>
            </div>
            
            <!-- Environmental Message -->
            <div class="environmental-message">
                Respect for the planet drives Interu. We build tools to organize and move natural resources responsibly, helping protect the environment.
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>
    </div>

    <script>
        let authToken = localStorage.getItem('supplierToken');
        let supplierLinkId = window.location.pathname.split('/').pop();
        let referenceList = [];

        // Check if already authenticated
        if (authToken) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('preview-panel').classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function switchRole(role) {
            if (role === 'customer') {
                window.location.href = '/customer';
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const title = document.getElementById(sectionId + '-title');
            
            if (section.classList.contains('collapsed')) {
                section.classList.remove('collapsed');
                title.textContent = title.textContent.replace('▶', '▼');
            } else {
                section.classList.add('collapsed');
                title.textContent = title.textContent.replace('▼', '▶');
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        function addReference() {
            const refNumber = document.getElementById('reference-number').value.trim();
            const valNumber = document.getElementById('validation-number').value.trim();
            
            if (!refNumber) {
                showAlert('Please enter a reference number', 'error');
                return;
            }

            // Add to reference list
            const reference = {
                id: Date.now(),
                referenceNumber: refNumber,
                validationNumber: valNumber || '-------'
            };
            referenceList.push(reference);

            // Clear inputs
            document.getElementById('reference-number').value = '';
            document.getElementById('validation-number').value = '';

            updateReferenceCards();
        }

        function updateReferenceCards() {
            const counter = document.getElementById('reference-counter');
            const cards = document.getElementById('reference-cards');
            
            counter.textContent = `${referenceList.length} References created`;
            
            if (referenceList.length === 0) {
                cards.innerHTML = '';
                return;
            }

            cards.innerHTML = referenceList.map(ref => `
                <div class="reference-card">
                    <button class="reference-card-close" onclick="removeReference(${ref.id})">×</button>
                    <div class="reference-card-content">
                        <div class="reference-card-field">
                            <div class="reference-card-label">Reference Number:</div>
                            <div class="reference-card-value">${ref.referenceNumber}</div>
                        </div>
                        <div class="reference-card-field">
                            <div class="reference-card-label">Validation Number:</div>
                            <div class="reference-card-value">${ref.validationNumber}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function removeReference(id) {
            referenceList = referenceList.filter(ref => ref.id !== id);
            updateReferenceCards();
        }

        function addCSVFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = handleCSVFile;
            input.click();
        }

        function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Parse CSV and add references
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',').map(v => v.trim());
                    if (values.length >= 3) {
                        const reference = {
                            id: Date.now() + i,
                            referenceNumber: values[2] || '',
                            validationNumber: values[3] || '-------'
                        };
                        if (reference.referenceNumber) {
                            referenceList.push(reference);
                        }
                    }
                }
                
                updateReferenceCards();
                showAlert(`Added ${referenceList.length} references from CSV`, 'success');
            };
            reader.readAsText(file);
        }

        async function submitAllReferences() {
            if (referenceList.length === 0) {
                showAlert('Please add at least one reference', 'error');
                return;
            }

            const poNumber = document.getElementById('po-number').value;
            const deliveryId = document.getElementById('delivery-id').value;
            const deliveryPostcode = document.getElementById('delivery-postcode').value;

            if (!poNumber || !deliveryId || !deliveryPostcode) {
                showAlert('Please fill in all purchase order information', 'error');
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;

                // Submit each reference individually
                for (const reference of referenceList) {
                    try {
                        const response = await fetch('/api/supplier/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({
                                poNumber,
                                deliveryId,
                                deliveryPostcode,
                                referenceNumber: reference.referenceNumber,
                                validationNumber: reference.validationNumber === '-------' ? '' : reference.validationNumber
                            })
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showAlert(`Successfully submitted ${successCount} reference(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
                    
                    // Clear references
                    referenceList = [];
                    updateReferenceCards();
                    
                    // Collapse PO section
                    toggleSection('po-section');
                } else {
                    showAlert('Failed to submit references', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }

        async function sendOTP() {
            const email = document.getElementById('email').value;
            if (!email) return showAlert('Please enter your email address', 'error');

            try {
                const response = await fetch('/api/supplier/verify-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, supplierLinkId })
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('email-form').classList.add('hidden');
                    document.getElementById('otp-form').classList.remove('hidden');
                    showAlert('Verification code sent to your email', 'success');
                } else {
                    showAlert(data.error || 'Failed to send OTP', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }

        async function verifyOTP() {
            const email = document.getElementById('email').value;
            const otp = document.getElementById('otp').value;
            
            if (!otp) return showAlert('Please enter the verification code', 'error');

            try {
                const response = await fetch('/api/supplier/validate-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, supplierLinkId })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('supplierToken', authToken);
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    document.getElementById('preview-panel').classList.remove('hidden');
                    showAlert('Authentication successful', 'success');
                } else {
                    showAlert(data.error || 'Invalid verification code', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }

        function resendOTP() {
            document.getElementById('email-form').classList.remove('hidden');
            document.getElementById('otp-form').classList.add('hidden');
        }

        async function testLogin() {
            try {
                if (!supplierLinkId) {
                    showAlert('No supplier link ID found in URL', 'error');
                    return;
                }

                const response = await fetch('/api/supplier/test-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supplierLinkId })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('supplierToken', authToken);
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    document.getElementById('preview-panel').classList.remove('hidden');
                    showAlert('Test authentication successful! Email: ' + data.email, 'success');
                } else {
                    showAlert(data.error || 'Test authentication failed', 'error');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/supplier/submissions', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    const historyContent = document.getElementById('history-content');
                    if (data.submissions.length === 0) {
                        historyContent.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 40px;">No submissions found.</p>';
                    } else {
                        // Group submissions by PO/Delivery
                        const grouped = {};
                        data.submissions.forEach(submission => {
                            const key = `${submission.po_number}-${submission.delivery_id}`;
                            if (!grouped[key]) {
                                grouped[key] = {
                                    poNumber: submission.po_number,
                                    deliveryId: submission.delivery_id,
                                    references: [],
                                    submittedAt: submission.submitted_at
                                };
                            }
                            grouped[key].references.push({
                                referenceNumber: submission.reference_number,
                                validationNumber: submission.validation_number,
                                submittedAt: submission.submitted_at
                            });
                            
                            // Keep the most recent submission time
                            if (new Date(submission.submitted_at) > new Date(grouped[key].submittedAt)) {
                                grouped[key].submittedAt = submission.submitted_at;
                            }
                        });

                        // Generate HTML for grouped submissions
                        historyContent.innerHTML = Object.values(grouped).map(group => `
                            <div class="submission-group">
                                <div class="group-header">
                                    <div>
                                        <strong>PO:</strong> ${group.poNumber} | <strong>Delivery:</strong> ${group.deliveryId}
                                    </div>
                                    <small class="submission-time">Last updated: ${new Date(group.submittedAt).toLocaleString()}</small>
                                </div>
                                <div class="references-list">
                                    ${group.references.map(ref => `
                                        <div class="reference-item">
                                            <span class="reference-number">${ref.referenceNumber}</span>
                                            ${ref.validationNumber ? `<span class="validation-number">${ref.validationNumber}</span>` : '<span class="validation-number">-</span>'}
                                            <small class="ref-time">${new Date(ref.submittedAt).toLocaleString()}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    showAlert(data.error || 'Failed to load history', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }
    </script>
</body>
</html>