<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Portal - DDS Validation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background: #f4f4f4; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { background: #007bff; color: white; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 2rem; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .hidden { display: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .form-row.three-col { grid-template-columns: 1fr 1fr auto; }
        .header-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #007bff; }
        .references-section { background: #fff; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 1rem; }
        .reference-row { border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-bottom: 10px; background: #f8f9fa; }
        .reference-row:last-child { margin-bottom: 15px; }
        .row-actions { display: flex; align-items: flex-end; }
        .row-actions .btn { margin-bottom: 0; height: fit-content; }
        .form-actions { text-align: center; padding-top: 1rem; border-top: 1px solid #e9ecef; }
        .btn { background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px 10px 0; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .alert { padding: 15px; margin: 15px 0; border-radius: 4px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .tabs { display: flex; margin-bottom: 1rem; }
        .tab { padding: 10px 20px; background: #e9ecef; border: 1px solid #ddd; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .submission-history { max-height: 400px; overflow-y: auto; }
        .submission-item { padding: 15px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; }
        .submission-group { margin-bottom: 20px; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; }
        .group-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .submission-time { color: #6c757d; font-size: 0.9em; }
        .references-list { padding: 10px; }
        .reference-item { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; padding: 10px; border-bottom: 1px solid #f1f3f4; align-items: center; }
        .reference-item:last-child { border-bottom: none; }
        .reference-number { font-weight: bold; color: #007bff; }
        .validation-number { color: #28a745; }
        .ref-time { color: #6c757d; font-size: 0.8em; }
        .csv-template { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: #007bff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Supplier Portal</h1>
            <p>Submit and manage reference numbers</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="card">
            <h2>Email Verification</h2>
            <div id="email-form">
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" placeholder="Enter your email address" required>
                </div>
                <button class="btn" onclick="sendOTP()">Send Verification Code</button>
                <button class="btn btn-secondary" onclick="testLogin()">Skip Email Verification (Test Mode)</button>
            </div>

            <div id="otp-form" class="hidden">
                <div class="form-group">
                    <label for="otp">Verification Code:</label>
                    <input type="text" id="otp" placeholder="Enter 6-digit code" maxlength="6" required>
                </div>
                <button class="btn" onclick="verifyOTP()">Verify Code</button>
                <button class="btn btn-secondary" onclick="resendOTP()">Resend Code</button>
            </div>
        </div>

        <!-- Main Application Section -->
        <div id="app-section" class="hidden">
            <div class="card">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('submit')">Submit References</div>
                    <div class="tab" onclick="showTab('bulk')">Bulk Upload</div>
                    <div class="tab" onclick="showTab('history')">History</div>
                </div>

                <!-- Submit Tab -->
                <div id="submit-tab" class="tab-content active">
                    <h3>Submit Reference Numbers</h3>
                    <form id="submit-form">
                        <!-- PO/Delivery Header Section -->
                        <div class="header-section">
                            <h4>Purchase Order Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="po-number">PO Number:</label>
                                    <input type="text" id="po-number" required>
                                </div>
                                <div class="form-group">
                                    <label for="delivery-id">Delivery ID:</label>
                                    <input type="text" id="delivery-id" required>
                                </div>
                            </div>
                        </div>

                        <!-- Reference Numbers Section -->
                        <div class="references-section">
                            <h4>Reference Numbers</h4>
                            <div id="reference-rows">
                                <div class="reference-row">
                                    <div class="form-row three-col">
                                        <div class="form-group">
                                            <label>Reference Number:</label>
                                            <input type="text" class="reference-number" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Validation Number (Optional):</label>
                                            <input type="text" class="validation-number">
                                        </div>
                                        <div class="form-group row-actions">
                                            <button type="button" class="btn btn-secondary remove-row" onclick="removeReferenceRow(this)" disabled>Remove</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addReferenceRow()">Add Another Reference</button>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn">Submit All References</button>
                        </div>
                    </form>
                </div>

                <!-- Bulk Upload Tab -->
                <div id="bulk-tab" class="tab-content">
                    <h3>Bulk CSV Upload</h3>
                    <div class="csv-template">
                        <h4>CSV Template:</h4>
                        <code>po_number,delivery_id,reference_number,validation_number</code>
                        <br><small>Headers must match exactly. validation_number is optional.</small>
                    </div>
                    <form id="bulk-form">
                        <div class="form-group">
                            <label for="csv-file">CSV File:</label>
                            <input type="file" id="csv-file" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn">Upload CSV</button>
                    </form>
                    <div id="upload-progress" class="hidden">
                        <div class="progress">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <p id="progress-text">Uploading...</p>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history-tab" class="tab-content">
                    <h3>Submission History</h3>
                    <button class="btn btn-secondary" onclick="loadHistory()">Refresh</button>
                    <div id="history-content" class="submission-history">
                        <p>Click refresh to load your submission history.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>
    </div>

    <script>
        let authToken = localStorage.getItem('supplierToken');
        let supplierLinkId = window.location.pathname.split('/').pop();

        // Check if already authenticated
        if (authToken) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        async function sendOTP() {
            const email = document.getElementById('email').value;
            if (!email) return showAlert('Please enter your email address', 'error');

            try {
                const response = await fetch('/api/supplier/verify-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, supplierLinkId })
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('email-form').classList.add('hidden');
                    document.getElementById('otp-form').classList.remove('hidden');
                    showAlert('Verification code sent to your email', 'success');
                } else {
                    showAlert(data.error || 'Failed to send OTP', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }

        async function verifyOTP() {
            const email = document.getElementById('email').value;
            const otp = document.getElementById('otp').value;
            
            if (!otp) return showAlert('Please enter the verification code', 'error');

            try {
                const response = await fetch('/api/supplier/validate-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp, supplierLinkId })
                });

                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('supplierToken', authToken);
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    showAlert('Authentication successful', 'success');
                } else {
                    showAlert(data.error || 'Invalid verification code', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }

        function resendOTP() {
            document.getElementById('email-form').classList.remove('hidden');
            document.getElementById('otp-form').classList.add('hidden');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        function addReferenceRow() {
            const referenceRows = document.getElementById('reference-rows');
            const newRow = document.createElement('div');
            newRow.className = 'reference-row';
            newRow.innerHTML = `
                <div class="form-row three-col">
                    <div class="form-group">
                        <label>Reference Number:</label>
                        <input type="text" class="reference-number" required>
                    </div>
                    <div class="form-group">
                        <label>Validation Number (Optional):</label>
                        <input type="text" class="validation-number">
                    </div>
                    <div class="form-group row-actions">
                        <button type="button" class="btn btn-secondary remove-row" onclick="removeReferenceRow(this)">Remove</button>
                    </div>
                </div>
            `;
            referenceRows.appendChild(newRow);
            updateRemoveButtons();
        }

        function removeReferenceRow(button) {
            const row = button.closest('.reference-row');
            row.remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const removeButtons = document.querySelectorAll('.remove-row');
            removeButtons.forEach(btn => {
                btn.disabled = removeButtons.length <= 1;
            });
        }

        // Submit form handler
        document.getElementById('submit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const poNumber = document.getElementById('po-number').value;
            const deliveryId = document.getElementById('delivery-id').value;
            
            // Collect all reference number rows
            const referenceRows = document.querySelectorAll('.reference-row');
            const references = [];
            
            referenceRows.forEach(row => {
                const referenceNumber = row.querySelector('.reference-number').value;
                const validationNumber = row.querySelector('.validation-number').value;
                
                if (referenceNumber.trim()) {
                    references.push({
                        poNumber,
                        deliveryId,
                        referenceNumber: referenceNumber.trim(),
                        validationNumber: validationNumber.trim()
                    });
                }
            });

            if (references.length === 0) {
                showAlert('Please enter at least one reference number', 'error');
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;

                // Submit each reference individually
                for (const reference of references) {
                    try {
                        const response = await fetch('/api/supplier/submit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(reference)
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    showAlert(`Successfully submitted ${successCount} reference(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
                    
                    // Reset form
                    document.getElementById('submit-form').reset();
                    
                    // Reset to single row
                    const referenceRowsContainer = document.getElementById('reference-rows');
                    referenceRowsContainer.innerHTML = `
                        <div class="reference-row">
                            <div class="form-row three-col">
                                <div class="form-group">
                                    <label>Reference Number:</label>
                                    <input type="text" class="reference-number" required>
                                </div>
                                <div class="form-group">
                                    <label>Validation Number (Optional):</label>
                                    <input type="text" class="validation-number">
                                </div>
                                <div class="form-group row-actions">
                                    <button type="button" class="btn btn-secondary remove-row" onclick="removeReferenceRow(this)" disabled>Remove</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    showAlert('Failed to submit references', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        });

        // Bulk upload form handler
        document.getElementById('bulk-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!file) return showAlert('Please select a CSV file', 'error');

            const formData = new FormData();
            formData.append('csvFile', file);

            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '10%';

            try {
                const response = await fetch('/api/supplier/bulk-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                progressBar.style.width = '100%';
                const data = await response.json();
                
                if (response.ok) {
                    const { summary } = data;
                    showAlert(`Upload completed: ${summary.created} created, ${summary.errors} errors`, 'success');
                    document.getElementById('bulk-form').reset();
                } else {
                    showAlert(data.error || 'Failed to upload CSV', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            } finally {
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        });

        async function testLogin() {
            try {
                console.log('Test login clicked, supplierLinkId:', supplierLinkId);
                
                if (!supplierLinkId) {
                    showAlert('No supplier link ID found in URL', 'error');
                    return;
                }

                showAlert('Attempting test login...', 'info');

                const response = await fetch('/api/supplier/test-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supplierLinkId })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('supplierToken', authToken);
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    showAlert('Test authentication successful! Email: ' + data.email, 'success');
                } else {
                    showAlert(data.error || 'Test authentication failed', 'error');
                }
            } catch (error) {
                console.error('Test login error:', error);
                showAlert('Network error: ' + error.message, 'error');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/supplier/submissions', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    const historyContent = document.getElementById('history-content');
                    if (data.submissions.length === 0) {
                        historyContent.innerHTML = '<p>No submissions found.</p>';
                    } else {
                        // Group submissions by PO/Delivery
                        const grouped = {};
                        data.submissions.forEach(submission => {
                            const key = `${submission.po_number}-${submission.delivery_id}`;
                            if (!grouped[key]) {
                                grouped[key] = {
                                    poNumber: submission.po_number,
                                    deliveryId: submission.delivery_id,
                                    references: [],
                                    submittedAt: submission.submitted_at
                                };
                            }
                            grouped[key].references.push({
                                referenceNumber: submission.reference_number,
                                validationNumber: submission.validation_number,
                                submittedAt: submission.submitted_at
                            });
                            
                            // Keep the most recent submission time
                            if (new Date(submission.submitted_at) > new Date(grouped[key].submittedAt)) {
                                grouped[key].submittedAt = submission.submitted_at;
                            }
                        });

                        // Generate HTML for grouped submissions
                        historyContent.innerHTML = Object.values(grouped).map(group => `
                            <div class="submission-group">
                                <div class="group-header">
                                    <strong>PO:</strong> ${group.poNumber} | <strong>Delivery:</strong> ${group.deliveryId}
                                    <small class="submission-time">Last updated: ${new Date(group.submittedAt).toLocaleString()}</small>
                                </div>
                                <div class="references-list">
                                    ${group.references.map(ref => `
                                        <div class="reference-item">
                                            <span class="reference-number">${ref.referenceNumber}</span>
                                            ${ref.validationNumber ? `<span class="validation-number">${ref.validationNumber}</span>` : '<span class="validation-number">-</span>'}
                                            <small class="ref-time">${new Date(ref.submittedAt).toLocaleString()}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    showAlert(data.error || 'Failed to load history', 'error');
                }
            } catch (error) {
                showAlert('Network error occurred', 'error');
            }
        }
    </script>
</body>
</html>